# PRD #0005: Autonomous SEO Agent Dashboard

**Date:** 2025-01-11
**Status:** Draft
**Priority:** Critical
**Identified By:** Tom All Autonomous Engine

## Problem Statement

Tom All identified **7 critical missing API endpoints** for the Autonomous SEO Agent:
- `/api/agents/autonomous-seo` (3 instances - different actions)
- `/api/agents/autonomous-seo?action=status`
- `/api/agents/autonomous-seo?action=schedules`
- `/api/agents/autonomous-seo?action=alerts`
- `/api/agents/autonomous-seo?action=recent-audits&limit=10`
- `/api/agents/autonomous-seo?type=schedule&id=[companyId]`
- `/api/clients/[companyId]/autopilot/[action]`

UI components are calling these endpoints but they don't exist, causing **broken Autonomous SEO Agent features**.

## Background

The Autonomous SEO Agent is a flagship feature that:
- Automatically runs SEO audits on schedule
- Monitors ranking changes and alerts on drops
- Generates and publishes content
- Identifies and fixes technical issues
- Reports progress and recommendations

This is the **"Tom for SEO"** - an autonomous system that runs 24/7 managing client SEO without human intervention.

**UI Components:** Already built in `app/agents/*` or `app/dashboard/*`

**Missing:** API routes and agent execution logic

## Goals

### Primary Goals
1. Create Autonomous SEO Agent API endpoints
2. Enable agent status monitoring (running/paused/error)
3. Enable schedule management (configure when agent runs)
4. Enable alert configuration (ranking drops, errors, opportunities)
5. Enable viewing recent audits and actions
6. Enable per-company agent controls (enable/disable/configure)

### Success Metrics
- All Autonomous SEO Agent endpoints return 200/201
- Agent runs on schedule automatically
- Alerts trigger and notify users
- Dashboard displays agent status and recent actions
- Users can enable/disable agent per company

## User Stories

### Agent Status & Monitoring
- **As a user**, I want to see if the autonomous agent is running
- **As a user**, I want to see what the agent is currently doing
- **As a user**, I want to see when the agent last ran
- **As a user**, I want to be notified if the agent encounters errors
- **As a user**, I want to see agent performance metrics

### Schedule Management
- **As a user**, I want to configure when the agent runs (daily, weekly, custom)
- **As a user**, I want to pause the agent temporarily
- **As a user**, I want to set agent priorities (audits, content, technical)
- **As a user**, I want to see the next scheduled run time

### Alert Configuration
- **As a user**, I want to set alert thresholds (ranking drop > 5 positions)
- **As a user**, I want to choose notification channels (email, SMS, Slack)
- **As a user**, I want to see recent alerts
- **As a user**, I want to configure alert frequency (don't spam me)

### Recent Activity
- **As a user**, I want to see recent audits run by the agent
- **As a user**, I want to see content generated by the agent
- **As a user**, I want to see technical issues fixed by the agent
- **As a user**, I want to see ranking improvements from agent actions

### Per-Company Controls
- **As a user**, I want to enable/disable the agent for specific companies
- **As a user**, I want to configure agent settings per company
- **As a user**, I want to see agent activity filtered by company

## Technical Specification

### API Endpoints Required

#### 1. Agent Status API (`/api/agents/autonomous-seo?action=status`)

**GET /api/agents/autonomous-seo?action=status**
- Returns: Current agent status
- Response:
```json
{
  "status": "running" | "paused" | "error",
  "current_task": "Running SEO audit for Company A",
  "last_run": "2025-01-11T10:30:00Z",
  "next_run": "2025-01-12T10:30:00Z",
  "stats": {
    "audits_today": 12,
    "content_generated": 5,
    "issues_fixed": 8,
    "alerts_sent": 2
  }
}
```

**POST /api/agents/autonomous-seo?action=pause**
- Pauses: Agent execution
- Response: `{ success: boolean, status: "paused" }`

**POST /api/agents/autonomous-seo?action=resume**
- Resumes: Agent execution
- Response: `{ success: boolean, status: "running" }`

#### 2. Schedules API (`/api/agents/autonomous-seo?action=schedules`)

**GET /api/agents/autonomous-seo?action=schedules**
- Returns: All agent schedules
- Response:
```json
{
  "schedules": [
    {
      "id": "uuid",
      "type": "audit",
      "frequency": "daily",
      "time": "10:00",
      "enabled": true,
      "companies": ["company-id-1", "company-id-2"]
    }
  ]
}
```

**POST /api/agents/autonomous-seo?action=schedules**
- Creates: New schedule
- Body: `{ type, frequency, time, companies }`
- Response: `{ schedule: Schedule }`

**PUT /api/agents/autonomous-seo/schedules/[id]**
- Updates: Schedule configuration
- Body: Partial schedule object
- Response: `{ schedule: Schedule }`

**DELETE /api/agents/autonomous-seo/schedules/[id]**
- Deletes: Schedule
- Response: `{ success: boolean }`

#### 3. Alerts API (`/api/agents/autonomous-seo?action=alerts`)

**GET /api/agents/autonomous-seo?action=alerts**
- Returns: Recent alerts
- Query params: `?limit=`, `?type=`, `?company_id=`
- Response:
```json
{
  "alerts": [
    {
      "id": "uuid",
      "type": "ranking_drop",
      "severity": "high",
      "company_id": "uuid",
      "message": "Keyword 'seo services' dropped 12 positions",
      "data": {
        "keyword": "seo services",
        "old_position": 5,
        "new_position": 17,
        "date": "2025-01-11"
      },
      "acknowledged": false,
      "created_at": "2025-01-11T09:15:00Z"
    }
  ],
  "total": 24
}
```

**POST /api/agents/autonomous-seo/alerts/[id]/acknowledge**
- Acknowledges: Alert (mark as read)
- Response: `{ success: boolean }`

**POST /api/agents/autonomous-seo/alerts/configure**
- Configures: Alert thresholds and channels
- Body:
```json
{
  "ranking_drop_threshold": 5,
  "performance_drop_threshold": 20,
  "channels": ["email", "slack"],
  "frequency": "immediate" | "daily_digest"
}
```
- Response: `{ config: AlertConfig }`

#### 4. Recent Audits API (`/api/agents/autonomous-seo?action=recent-audits&limit=10`)

**GET /api/agents/autonomous-seo?action=recent-audits**
- Returns: Recent audits run by agent
- Query params: `?limit=`, `?company_id=`
- Response:
```json
{
  "audits": [
    {
      "id": "uuid",
      "company_id": "uuid",
      "company_name": "Company A",
      "score": 85,
      "issues_found": 12,
      "issues_fixed": 8,
      "run_at": "2025-01-11T10:30:00Z",
      "duration_ms": 45000
    }
  ]
}
```

#### 5. Company Autopilot API (`/api/clients/[companyId]/autopilot/[action]`)

**GET /api/clients/[companyId]/autopilot/status**
- Returns: Agent status for specific company
- Response:
```json
{
  "company_id": "uuid",
  "enabled": true,
  "schedule": "daily",
  "last_run": "2025-01-11T10:30:00Z",
  "next_run": "2025-01-12T10:30:00Z",
  "stats": {
    "audits_run": 45,
    "issues_fixed": 120,
    "content_generated": 18,
    "ranking_improvements": 35
  }
}
```

**POST /api/clients/[companyId]/autopilot/enable**
- Enables: Agent for company
- Body: `{ schedule, features: ["audits", "content", "technical"] }`
- Response: `{ success: boolean }`

**POST /api/clients/[companyId]/autopilot/disable**
- Disables: Agent for company
- Response: `{ success: boolean }`

**POST /api/clients/[companyId]/autopilot/run-now**
- Triggers: Immediate agent run (bypass schedule)
- Response: `{ execution_id: string }`

### Database Schema

**New tables required:**

```sql
-- Agent schedules
CREATE TABLE agent_schedules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  type VARCHAR(50) NOT NULL, -- 'audit', 'content', 'technical', 'rankings'
  frequency VARCHAR(50), -- 'daily', 'weekly', 'custom'
  cron_expression VARCHAR(100), -- For custom schedules
  time TIME,
  enabled BOOLEAN DEFAULT TRUE,
  companies JSONB, -- Array of company IDs
  config JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Agent alerts
CREATE TABLE agent_alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  type VARCHAR(50) NOT NULL, -- 'ranking_drop', 'performance_drop', 'error', 'opportunity'
  severity VARCHAR(20), -- 'low', 'medium', 'high', 'critical'
  company_id UUID,
  message TEXT NOT NULL,
  data JSONB,
  acknowledged BOOLEAN DEFAULT FALSE,
  acknowledged_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Alert configuration
CREATE TABLE agent_alert_config (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID,
  ranking_drop_threshold INT DEFAULT 5,
  performance_drop_threshold INT DEFAULT 20,
  channels JSONB, -- ["email", "slack", "sms"]
  frequency VARCHAR(50), -- 'immediate', 'hourly', 'daily_digest'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Company autopilot settings
CREATE TABLE company_autopilot (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_id UUID NOT NULL REFERENCES companies(id),
  enabled BOOLEAN DEFAULT FALSE,
  schedule VARCHAR(50) DEFAULT 'daily',
  features JSONB, -- ["audits", "content", "technical", "rankings"]
  last_run TIMESTAMP,
  next_run TIMESTAMP,
  stats JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### TypeScript Types

```typescript
// types/agent.ts
export interface AgentStatus {
  status: 'running' | 'paused' | 'error';
  current_task?: string;
  last_run?: string;
  next_run?: string;
  stats: {
    audits_today: number;
    content_generated: number;
    issues_fixed: number;
    alerts_sent: number;
  };
}

export interface AgentSchedule {
  id: string;
  type: 'audit' | 'content' | 'technical' | 'rankings';
  frequency: 'daily' | 'weekly' | 'custom';
  time?: string;
  cron_expression?: string;
  enabled: boolean;
  companies?: string[];
  config?: any;
  created_at: string;
  updated_at: string;
}

export interface AgentAlert {
  id: string;
  type: 'ranking_drop' | 'performance_drop' | 'error' | 'opportunity';
  severity: 'low' | 'medium' | 'high' | 'critical';
  company_id?: string;
  message: string;
  data?: any;
  acknowledged: boolean;
  acknowledged_at?: string;
  created_at: string;
}

export interface CompanyAutopilot {
  company_id: string;
  enabled: boolean;
  schedule: string;
  features: string[];
  last_run?: string;
  next_run?: string;
  stats?: any;
}
```

### Agent Execution Logic

**Agent Runner** (background process using node-cron):

```typescript
// services/agent/autonomous-seo-runner.ts
import cron from 'node-cron';
import { runAudit } from './tasks/audit';
import { generateContent } from './tasks/content';
import { fixTechnical } from './tasks/technical';

export class AutonomousSEOAgent {
  private tasks: cron.ScheduledTask[] = [];

  async start() {
    // Load schedules from database
    const schedules = await getActiveSchedules();

    schedules.forEach(schedule => {
      const task = cron.schedule(schedule.cron_expression, async () => {
        await this.executeSchedule(schedule);
      });

      this.tasks.push(task);
    });
  }

  async executeSchedule(schedule: AgentSchedule) {
    for (const companyId of schedule.companies) {
      try {
        switch (schedule.type) {
          case 'audit':
            await runAudit(companyId);
            break;
          case 'content':
            await generateContent(companyId);
            break;
          case 'technical':
            await fixTechnical(companyId);
            break;
        }
      } catch (error) {
        await createAlert({
          type: 'error',
          severity: 'high',
          company_id: companyId,
          message: `Agent task failed: ${error.message}`,
          data: { error: error.stack }
        });
      }
    }
  }
}
```

### Error Handling

All endpoints must:
- Use `createAdminClient()` (avoid RLS issues)
- Validate input with Zod schemas
- Handle agent errors gracefully (don't crash)
- Log all agent actions for debugging
- Create alerts for critical errors

## User Journeys

### Journey 1: View Agent Status
1. User navigates to `/agents` dashboard
2. Page loads → `GET /api/agents/autonomous-seo?action=status`
3. User sees agent is "running"
4. User sees current task: "Running audit for Company A"
5. User sees stats: 12 audits today, 8 issues fixed

### Journey 2: Configure Schedule
1. User clicks "Manage Schedules"
2. Page loads → `GET /api/agents/autonomous-seo?action=schedules`
3. User clicks "Add Schedule"
4. Selects type: "Audit", frequency: "Daily", time: "10:00 AM"
5. Selects companies to audit
6. Submits → `POST /api/agents/autonomous-seo?action=schedules`
7. Schedule appears in list
8. Agent runs automatically at 10 AM daily

### Journey 3: Manage Alerts
1. User navigates to alerts section
2. Page loads → `GET /api/agents/autonomous-seo?action=alerts`
3. User sees alert: "Keyword 'seo services' dropped 12 positions"
4. User clicks alert to view details
5. User acknowledges alert → `POST /api/agents/autonomous-seo/alerts/[id]/acknowledge`
6. Alert marked as read

### Journey 4: Enable Autopilot for Company
1. User viewing company detail page
2. Sees "Autopilot: Disabled" badge
3. Clicks "Enable Autopilot"
4. Configures schedule and features
5. Submits → `POST /api/clients/[companyId]/autopilot/enable`
6. Agent starts running for that company
7. User sees next run time

## Acceptance Criteria

- [ ] All 7+ agent API endpoints created
- [ ] All endpoints return proper status codes (not 404)
- [ ] All endpoints use `createAdminClient()` (no RLS errors)
- [ ] Agent runner service created (background process)
- [ ] Agent executes tasks on schedule
- [ ] Alerts created and displayed
- [ ] Per-company autopilot controls working
- [ ] All user journeys working end-to-end
- [ ] Tom Genie validation passes (zero critical issues)

## Out of Scope

- Machine learning models (future)
- Multi-language support (future)
- Advanced A/B testing (future)
- White-label agent for resellers (future)

## Dependencies

- node-cron for scheduling
- Existing audit/content/technical services
- Database schema migrations
- Email/notification services

## Risks & Mitigations

**Risk:** Agent runs too frequently, hits API rate limits
**Mitigation:** Rate limiting, backoff strategy

**Risk:** Agent breaks things automatically
**Mitigation:** Dry-run mode, user approval for critical changes

**Risk:** Agent fails silently
**Mitigation:** Comprehensive error alerting

## Timeline

- **Implementation:** 10-12 hours
- **Testing:** 3 hours
- **Integration & bug fixes:** 2 hours

**Total:** 15-17 hours

## Success Criteria

1. ✅ All agent endpoints functional
2. ✅ Agent runs on schedule
3. ✅ Alerts trigger correctly
4. ✅ Dashboard displays status
5. ✅ Per-company controls working
6. ✅ Tom Genie validation passes
