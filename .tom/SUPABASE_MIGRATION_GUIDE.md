# 🗄️ SUPABASE MIGRATION GUIDE
**Migration**: 012_autonomous_seo_agent_postgres.sql
**Target**: Supabase Production Database
**PRD**: #0005 - Autonomous SEO Agent Dashboard

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📋 Overview

This migration adds 4 new tables to support the Autonomous SEO Agent system:

1. **agent_schedules** - Scheduled tasks for the autonomous agent
2. **agent_alerts** - Alerts generated by the agent (ranking drops, errors, opportunities)
3. **agent_alert_config** - User preferences for alert thresholds and channels
4. **company_autopilot** - Per-company autopilot configuration

**Total Tables**: 4
**Total Indexes**: 11
**RLS Policies**: 4 (service role full access)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🚀 HOW TO APPLY MIGRATION TO SUPABASE

### Step 1: Access Supabase Dashboard

1. Go to https://supabase.com/dashboard
2. Navigate to your project: **geo-seo-domination-tool**
3. Click **SQL Editor** in the left sidebar

### Step 2: Run the Migration

1. Click **New Query**
2. Copy the ENTIRE contents of `database/migrations/012_autonomous_seo_agent_postgres.sql`
3. Paste into the SQL editor
4. Click **Run** (or press Ctrl+Enter)

### Step 3: Verify Tables Created

Run this verification query:

\`\`\`sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN (
    'agent_schedules',
    'agent_alerts',
    'agent_alert_config',
    'company_autopilot'
  )
ORDER BY table_name;
\`\`\`

**Expected Output** (4 rows):
```
agent_alert_config
agent_alerts
agent_schedules
company_autopilot
```

### Step 4: Verify Indexes Created

Run this verification query:

\`\`\`sql
SELECT
  schemaname,
  tablename,
  indexname
FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename IN ('agent_schedules', 'agent_alerts', 'agent_alert_config', 'company_autopilot')
ORDER BY tablename, indexname;
\`\`\`

**Expected Output**: 11 indexes total

### Step 5: Verify RLS Policies

Run this verification query:

\`\`\`sql
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('agent_schedules', 'agent_alerts', 'agent_alert_config', 'company_autopilot')
ORDER BY tablename, policyname;
\`\`\`

**Expected Output**: 4 policies (one per table, all allowing service role full access)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📝 MIGRATION SQL (Copy This)

**Location**: `database/migrations/012_autonomous_seo_agent_postgres.sql`

**Direct Copy**:
\`\`\`sql
-- [See file contents in database/migrations/012_autonomous_seo_agent_postgres.sql]
\`\`\`

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## ⚠️ IMPORTANT NOTES

### Foreign Key Dependencies

The migration assumes the following tables already exist:
- **companies** table (referenced by `agent_alerts.company_id` and `company_autopilot.company_id`)

If `companies` table doesn't exist, you'll get an error. Verify first:

\`\`\`sql
SELECT EXISTS (
  SELECT FROM information_schema.tables
  WHERE table_schema = 'public'
  AND table_name = 'companies'
);
\`\`\`

### Data Type Differences (SQLite vs PostgreSQL)

| SQLite (Local Dev) | PostgreSQL (Supabase) | Notes |
|-------------------|----------------------|-------|
| `TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16))))` | `UUID PRIMARY KEY DEFAULT gen_random_uuid()` | UUID generation |
| `BOOLEAN DEFAULT 1` | `BOOLEAN DEFAULT true` | Boolean literals |
| `DATETIME DEFAULT CURRENT_TIMESTAMP` | `TIMESTAMPTZ DEFAULT NOW()` | Timestamps |
| `TEXT` (for JSON) | `JSONB` | JSON columns |

The migration file `012_autonomous_seo_agent_postgres.sql` already handles these differences.

### RLS (Row Level Security)

All 4 tables have RLS enabled with permissive policies for the service role. This matches the pattern used in our API endpoints which use `createAdminClient()` (service role key).

**Policy Pattern**:
\`\`\`sql
ALTER TABLE [table_name] ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow service role full access to [table_name]" ON [table_name]
  FOR ALL USING (true);
\`\`\`

This ensures our API endpoints (which use admin client) can access all rows without RLS restrictions.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🧪 POST-MIGRATION TESTING

After running the migration, test the new endpoints:

### 1. Test Agent Status Endpoint

\`\`\`bash
curl https://geo-seo-domination-tool-qybjjcrlj-unite-group.vercel.app/api/agents/autonomous-seo?action=status
\`\`\`

**Expected Response**:
\`\`\`json
{
  "status": "paused",
  "stats": {
    "audits_today": 0,
    "content_generated": 0,
    "issues_fixed": 0,
    "alerts_sent": 0
  }
}
\`\`\`

### 2. Test Schedules Endpoint

\`\`\`bash
curl https://geo-seo-domination-tool-qybjjcrlj-unite-group.vercel.app/api/agents/autonomous-seo?action=schedules
\`\`\`

**Expected Response**:
\`\`\`json
{
  "schedules": []
}
\`\`\`

### 3. Test Autopilot Status (Replace [companyId] with actual ID)

\`\`\`bash
curl https://geo-seo-domination-tool-qybjjcrlj-unite-group.vercel.app/api/clients/[companyId]/autopilot/status
\`\`\`

**Expected Response**:
\`\`\`json
{
  "company_id": "[companyId]",
  "enabled": false,
  "schedule": "daily",
  "features": [],
  "stats": {}
}
\`\`\`

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 🔄 ROLLBACK (If Needed)

If you need to rollback this migration:

\`\`\`sql
DROP TABLE IF EXISTS company_autopilot CASCADE;
DROP TABLE IF EXISTS agent_alert_config CASCADE;
DROP TABLE IF EXISTS agent_alerts CASCADE;
DROP TABLE IF EXISTS agent_schedules CASCADE;
\`\`\`

**⚠️ WARNING**: This will delete all data in these tables. Use with caution.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## ✅ MIGRATION CHECKLIST

- [ ] Access Supabase dashboard
- [ ] Open SQL Editor
- [ ] Create new query
- [ ] Copy migration SQL from `012_autonomous_seo_agent_postgres.sql`
- [ ] Run migration (click Run button)
- [ ] Verify 4 tables created
- [ ] Verify 11 indexes created
- [ ] Verify 4 RLS policies created
- [ ] Test agent status endpoint
- [ ] Test schedules endpoint
- [ ] Test autopilot status endpoint
- [ ] Mark migration as applied in tracking system

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📚 Related Documentation

- **PRD**: [tasks/0005-prd-autonomous-seo-agent.md](../tasks/0005-prd-autonomous-seo-agent.md)
- **API Endpoints**: 7+ endpoints in `app/api/agents/autonomous-seo/` and `app/api/clients/[companyId]/autopilot/`
- **Type Definitions**: [types/agent.ts](../types/agent.ts)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**Migration Guide Created**: October 11, 2025, 12:05 PM
**Status**: Ready to apply
**Target**: Supabase Production Database
